<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>IndexedDB ZIP Storage Prototype</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
        line-height: 1.6;
      }
      .container {
        display: flex;
        flex-direction: column;
        gap: 20px;
      }
      .card {
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }
      .upload-container {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }
      .button {
        background-color: #4a7bff;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
      }
      .button:hover {
        background-color: #3a6ae6;
      }
      .button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }
      .status {
        padding: 10px;
        margin-top: 10px;
        border-radius: 4px;
      }
      .status.success {
        background-color: #d4edda;
        color: #155724;
      }
      .status.error {
        background-color: #f8d7da;
        color: #721c24;
      }
      .status.warning {
        background-color: #fff3cd;
        color: #856404;
      }
      .status.info {
        background-color: #d1ecf1;
        color: #0c5460;
      }
      pre {
        background-color: #f5f5f5;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
        max-height: 400px;
        overflow-y: auto;
      }
      table {
        width: 100%;
        border-collapse: collapse;
      }
      table,
      th,
      td {
        border: 1px solid #ddd;
      }
      th,
      td {
        padding: 8px;
        text-align: left;
      }
      th {
        background-color: #f2f2f2;
      }
      .input-file {
        display: none;
      }
      .file-label {
        display: inline-block;
        background-color: #6c757d;
        color: white;
        padding: 10px 15px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
      }
      .file-label:hover {
        background-color: #5a6268;
      }
      .db-controls {
        display: flex;
        gap: 10px;
      }
    </style>
  </head>
  <body>
    <h1>IndexedDB ZIP Storage Prototype</h1>

    <div class="container">
      <div class="card">
        <h2>Upload ZIP File</h2>
        <div class="upload-container">
          <div>
            <label for="zipFile" class="file-label">Choose ZIP File</label>
            <input type="file" id="zipFile" accept=".zip" class="input-file" />
            <span id="fileName">No file selected</span>
          </div>
          <button id="uploadBtn" class="button" disabled>
            Upload to IndexedDB
          </button>
          <div id="uploadStatus"></div>
        </div>
      </div>

      <div class="card">
        <h2>Database Management</h2>
        <div class="db-controls">
          <button id="viewDbBtn" class="button">View Database Content</button>
          <button id="clearDbBtn" class="button">Clear Database</button>
        </div>
        <div id="dbStatus"></div>
      </div>

      <div class="card">
        <h2>Database Content</h2>
        <div id="dbContent"></div>
      </div>
    </div>

    <script>
      // IndexedDB variables
      const DB_NAME = "ZipFileDB";
      const DB_VERSION = 1;
      const STORE_NAME = "zipFiles";
      let db;

      // DOM elements
      const zipFileInput = document.getElementById("zipFile");
      const fileNameDisplay = document.getElementById("fileName");
      const uploadBtn = document.getElementById("uploadBtn");
      const uploadStatus = document.getElementById("uploadStatus");
      const viewDbBtn = document.getElementById("viewDbBtn");
      const clearDbBtn = document.getElementById("clearDbBtn");
      const dbStatus = document.getElementById("dbStatus");
      const dbContent = document.getElementById("dbContent");

      // Initialize IndexedDB
      function initIndexedDB() {
        return new Promise((resolve, reject) => {
          const request = indexedDB.open(DB_NAME, DB_VERSION);

          request.onerror = (event) => {
            console.error("IndexedDB error:", event.target.error);
            showStatus(
              "error",
              `Failed to open database: ${event.target.error.message}`,
              dbStatus
            );
            reject(event.target.error);
          };

          request.onsuccess = (event) => {
            db = event.target.result;
            console.log("Database opened successfully");
            showStatus("success", "Database opened successfully", dbStatus);
            resolve(db);
          };

          request.onupgradeneeded = (event) => {
            const db = event.target.result;
            console.log("Creating object store");

            // Create object store for zip files if it doesn't exist
            if (!db.objectStoreNames.contains(STORE_NAME)) {
              const store = db.createObjectStore(STORE_NAME, {
                keyPath: "id",
                autoIncrement: true,
              });
              store.createIndex("name", "name", {unique: false});
              store.createIndex("timestamp", "timestamp", {unique: false});
            }
          };
        });
      }

      // Save ZIP file to IndexedDB
      async function saveZipFile(file) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();

          reader.onload = async (event) => {
            try {
              const arrayBuffer = event.target.result;
              const jszip = new JSZip();
              const zip = await jszip.loadAsync(arrayBuffer);

              // Process ZIP contents
              const files = [];
              let totalSize = 0;

              for (const [path, zipEntry] of Object.entries(zip.files)) {
                if (!zipEntry.dir) {
                  const content = await zipEntry.async("string");
                  files.push({
                    path,
                    size: content.length,
                    content:
                      content.length > 1000
                        ? content.substring(0, 1000) + "...[truncated]"
                        : content,
                  });
                  totalSize += content.length;
                }
              }

              // Save to IndexedDB
              const transaction = db.transaction([STORE_NAME], "readwrite");
              const store = transaction.objectStore(STORE_NAME);

              const zipData = {
                name: file.name,
                size: file.size,
                timestamp: new Date().toISOString(),
                fileCount: files.length,
                totalSize,
                files,
              };

              const request = store.add(zipData);

              request.onsuccess = (event) => {
                console.log("Zip file saved successfully");
                resolve(event.target.result);
              };

              request.onerror = (event) => {
                console.error("Error saving zip file:", event.target.error);
                reject(event.target.error);
              };
            } catch (error) {
              console.error("Error processing zip file:", error);
              reject(error);
            }
          };

          reader.onerror = (event) => {
            console.error("Error reading file:", event.target.error);
            reject(event.target.error);
          };

          reader.readAsArrayBuffer(file);
        });
      }

      // Get all ZIP files from IndexedDB
      async function getAllZipFiles() {
        return new Promise((resolve, reject) => {
          if (!db) {
            reject(new Error("Database not initialized"));
            return;
          }

          const transaction = db.transaction([STORE_NAME], "readonly");
          const store = transaction.objectStore(STORE_NAME);
          const request = store.getAll();

          request.onsuccess = (event) => {
            resolve(event.target.result);
          };

          request.onerror = (event) => {
            console.error("Error getting zip files:", event.target.error);
            reject(event.target.error);
          };
        });
      }

      // Clear all ZIP files from IndexedDB
      async function clearZipFiles() {
        return new Promise((resolve, reject) => {
          if (!db) {
            reject(new Error("Database not initialized"));
            return;
          }

          const transaction = db.transaction([STORE_NAME], "readwrite");
          const store = transaction.objectStore(STORE_NAME);
          const request = store.clear();

          request.onsuccess = (event) => {
            resolve();
          };

          request.onerror = (event) => {
            console.error("Error clearing zip files:", event.target.error);
            reject(event.target.error);
          };
        });
      }

      // Display status message
      function showStatus(type, message, element) {
        element.innerHTML = `<div class="status ${type}">${message}</div>`;

        // Clear status after 5 seconds
        setTimeout(() => {
          element.innerHTML = "";
        }, 5000);
      }

      // Display database content
      function displayDbContent(zipFiles) {
        if (zipFiles.length === 0) {
          dbContent.innerHTML = "<p>No ZIP files stored in the database.</p>";
          return;
        }

        let html = "<table>";
        html +=
          "<tr><th>ID</th><th>Name</th><th>Size</th><th>Files</th><th>Timestamp</th></tr>";

        for (const zipFile of zipFiles) {
          html += `
                    <tr>
                        <td>${zipFile.id}</td>
                        <td>${zipFile.name}</td>
                        <td>${formatSize(zipFile.size)}</td>
                        <td>${zipFile.fileCount}</td>
                        <td>${new Date(zipFile.timestamp).toLocaleString()}</td>
                    </tr>
                `;
        }

        html += "</table>";

        // Add file details for the most recent upload
        const mostRecent = zipFiles[zipFiles.length - 1];
        if (mostRecent) {
          html += `<h3>Content of ${mostRecent.name} (showing ${mostRecent.files.length} files)</h3>`;
          html += "<pre>";

          mostRecent.files.forEach((file, index) => {
            if (index < 10) {
              // Limit to first 10 files to avoid overloading the UI
              html += `<strong>${file.path}</strong> (${formatSize(
                file.size
              )}):\n`;
              html += `${file.content}\n\n`;
            }
          });

          if (mostRecent.files.length > 10) {
            html += `... and ${mostRecent.files.length - 10} more files`;
          }

          html += "</pre>";
        }

        dbContent.innerHTML = html;
      }

      // Format file size
      function formatSize(bytes) {
        if (bytes < 1024) {
          return bytes + " bytes";
        } else if (bytes < 1024 * 1024) {
          return (bytes / 1024).toFixed(2) + " KB";
        } else {
          return (bytes / (1024 * 1024)).toFixed(2) + " MB";
        }
      }

      // Event listeners
      zipFileInput.addEventListener("change", (event) => {
        const file = event.target.files[0];
        if (file) {
          fileNameDisplay.textContent = file.name;
          uploadBtn.disabled = false;
        } else {
          fileNameDisplay.textContent = "No file selected";
          uploadBtn.disabled = true;
        }
      });

      uploadBtn.addEventListener("click", async () => {
        const file = zipFileInput.files[0];
        if (!file) {
          showStatus("error", "No file selected", uploadStatus);
          return;
        }

        if (!file.name.endsWith(".zip")) {
          showStatus("error", "Please select a ZIP file", uploadStatus);
          return;
        }

        uploadBtn.disabled = true;
        showStatus("info", "Uploading...", uploadStatus);

        try {
          await saveZipFile(file);
          showStatus(
            "success",
            "ZIP file uploaded successfully!",
            uploadStatus
          );

          // Reset file input
          zipFileInput.value = "";
          fileNameDisplay.textContent = "No file selected";

          // Display the updated database content
          const zipFiles = await getAllZipFiles();
          displayDbContent(zipFiles);
        } catch (error) {
          console.error("Error uploading ZIP file:", error);
          showStatus(
            "error",
            `Error uploading ZIP file: ${error.message}`,
            uploadStatus
          );
        } finally {
          uploadBtn.disabled = false;
        }
      });

      viewDbBtn.addEventListener("click", async () => {
        try {
          const zipFiles = await getAllZipFiles();
          displayDbContent(zipFiles);
          showStatus("success", "Database content loaded", dbStatus);
        } catch (error) {
          console.error("Error viewing database:", error);
          showStatus(
            "error",
            `Error viewing database: ${error.message}`,
            dbStatus
          );
        }
      });

      clearDbBtn.addEventListener("click", async () => {
        try {
          await clearZipFiles();
          dbContent.innerHTML = "<p>No ZIP files stored in the database.</p>";
          showStatus("success", "Database cleared successfully", dbStatus);
        } catch (error) {
          console.error("Error clearing database:", error);
          showStatus(
            "error",
            `Error clearing database: ${error.message}`,
            dbStatus
          );
        }
      });

      // Initialize the application
      (async function init() {
        try {
          await initIndexedDB();
          const zipFiles = await getAllZipFiles();
          displayDbContent(zipFiles);
        } catch (error) {
          console.error("Initialization error:", error);
          showStatus(
            "error",
            `Initialization error: ${error.message}`,
            dbStatus
          );
        }
      })();
    </script>
  </body>
</html>
